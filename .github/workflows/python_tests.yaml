name: Run Python Tests for Niffler

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        working-directory: ./niffler-tests-python
        run: |
          cat > .env << EOF
          USER_NAME="${{ secrets.USER_NAME }}"
          PASSWORD="${{ secrets.PASSWORD }}"
          FRONT_URL="http://frontend.niffler.dc"
          AUTH_URL="http://auth.niffler.dc:9000"
          GATEWAY_URL="http://gateway.niffler.dc:8090"
          SPEND_DB_URL="postgresql+psycopg2://postgres:secret@localhost:5432/niffler-spend"
          AUTH_DB_URL="postgresql+psycopg2://postgres:secret@localhost:5432/niffler-auth"
          USERDATA_DB_URL="postgresql+psycopg2://postgres:secret@localhost:5432/niffler-userdata"
          KAFKA_BOOTSTRAP_SERVERS="localhost:9093"
          EOF
          
          echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω:"
          cat .env | grep -v PASSWORD | grep -v SECRET

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set PYTHONPATH
        run: |
          echo "PYTHONPATH=$(pwd):$PYTHONPATH" >> $GITHUB_ENV

      - name: Install poetry
        run: |
          pip install --upgrade pip
          pip install poetry==2.0.1


      - name: Install dependencies with Poetry
        working-directory: ./niffler-tests-python
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi --no-root

      - name: Install Playwright browsers
        working-directory: ./niffler-tests-python
        run: |
          poetry run playwright install chromium
          poetry run playwright install-deps


      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build containers
        run: |
            bash docker-compose-dev.sh
          sleep 30
          
          echo -n "  –ü—Ä–æ–≤–µ—Ä–∫–∞ gateway: "
          max_attempts=30  # 30 –ø–æ–ø—ã—Ç–æ–∫ –ø–æ 2 —Å–µ–∫—É–Ω–¥—ã = 1 –º–∏–Ω—É—Ç–∞
          for i in $(seq 1 $max_attempts); do
            if curl -s http://gateway.niffler.dc:8090/actuator/health | grep -q "UP"; then
              echo "‚úÖ –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ $((i*2)) —Å–µ–∫—É–Ω–¥"
              break
            fi
            if [ $i -eq $max_attempts ]; then
              echo "‚ùå –Ω–µ –¥–æ–∂–¥–∞–ª–∏—Å—å"
              exit 1
            fi
            sleep 2
          done
          
          echo -n "  –ü—Ä–æ–≤–µ—Ä–∫–∞ auth: "
          for i in $(seq 1 20); do
            if curl -s http://auth.niffler.dc:9000/actuator/health | grep -q "UP"; then
              echo "‚úÖ –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ $((i*2)) —Å–µ–∫—É–Ω–¥"
              break
            fi
            sleep 2
          done
          sleep 10
          
          echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≥–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∞–º"

#      - name: Add hosts to /etc/hosts
#        run: |
#          echo "127.0.0.1 frontend.niffler.dc" | sudo tee -a /etc/hosts
#          echo "127.0.0.1 auth.niffler.dc" | sudo tee -a /etc/hosts
#          echo "127.0.0.1 gateway.niffler.dc" | sudo tee -a /etc/hosts
#          cat /etc/hosts | grep niffler
      - name: Add hosts with IPs
        run: |
          echo -e "127.0.0.1\tlocalhost\n127.0.0.1\tfrontend.niffler.dc\n127.0.0.1\tauth.niffler.dc\n127.0.0.1\tgateway.niffler.dc\n127.0.0.1\tuserdata.niffler.dc\n127.0.0.1\tkafka" | sudo tee -a /etc/hosts
#        run: |
#            # –ü–æ–ª—É—á–∞–µ–º IP –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
#            AUTH_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' auth.niffler.dc)
#            GATEWAY_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' gateway.niffler.dc)
#            FRONTEND_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' frontend.niffler.dc)
#
#            echo "Auth IP: $AUTH_IP"
#            echo "Gateway IP: $GATEWAY_IP"
#            echo "Frontend IP: $FRONTEND_IP"
#
#            # –î–æ–±–∞–≤–ª—è–µ–º –≤ hosts
#            echo "$AUTH_IP auth.niffler.dc" | sudo tee -a /etc/hosts
#            echo "$GATEWAY_IP gateway.niffler.dc" | sudo tee -a /etc/hosts
#            echo "$FRONTEND_IP frontend.niffler.dc" | sudo tee -a /etc/hosts


      - name: Run tests with pytest
        working-directory: ./niffler-tests-python
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Python..."
          poetry run pytest -v --tb=long --capture=no
        continue-on-error: false
      - name: Upload Logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pytest-logs
          path: niffler-tests-python/logs

      - name: Load test report history
        uses: actions/checkout@v3
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: niffler-tests-python/allure-results
          allure_history: gh-pages/history
          allure_report: niffler-tests-python/allure-report
          gh_pages: gh-pages
          keep_reports: 20

      - name: Upload Allure Report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: niffler-tests-python/allure-report

      - name: Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: gh-pages/history
          keep_files: true

#      - name: Upload Allure results
#        uses: actions/upload-artifact@v4
#        if: always()
#        with:
#          name: allure-results
#          path: niffler-tests-python/allure-results/
#          retention-days: 30
#
#  allure-report:
#    needs: test
#    if: always()
#    runs-on: ubuntu-latest
#    steps:
#      - name: Download all Allure results
#        uses: actions/download-artifact@v4
#        with:
#          path: allure-results
#          pattern: allure-results-*
#          merge-multiple: true
#
#      - name: Generate Allure Report
#        uses: simple-elf/allure-report-action@v1.12
#        with:
#          allure_results: niffler-tests-python/allure-results
#          allure_history: gh-pages/history
#          allure_report: niffler-e-2-e-tests-python/allure-report
#          gh_pages: gh-pages
#          keep_reports: 20
#
#      - name: Deploy Allure report to GitHub Pages
#        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
#        uses: peaceiris/actions-gh-pages@v4
#        with:
#          github_token: ${{ secrets.GITHUB_TOKEN }}
#          publish_branch: gh-pages
#          publish_dir: allure-history
#          destination_dir: ${{ github.run_number }}
