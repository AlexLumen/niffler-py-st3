name: Run Python Tests for Niffler

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        working-directory: ./niffler-tests-python
        run: |
          cat > .env << EOF
          USER_NAME="${{ secrets.USER_NAME }}"
          PASSWORD="${{ secrets.PASSWORD }}"
          FRONT_URL="http://frontend.niffler.dc"
          AUTH_URL="http://auth.niffler.dc:9000"
          GATEWAY_URL="http://gateway.niffler.dc:8090"
          SPEND_DB_URL="postgresql+psycopg2://postgres:secret@localhost:5432/niffler-spend"
          AUTH_DB_URL="postgresql+psycopg2://postgres:secret@localhost:5432/niffler-auth"
          USERDATA_DB_URL="postgresql+psycopg2://postgres:secret@localhost:5432/niffler-userdata"
          KAFKA_BOOTSTRAP_SERVERS="localhost:9093"
          EOF
          
          echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω:"
          cat .env | grep -v PASSWORD | grep -v SECRET

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set PYTHONPATH
        run: |
          echo "PYTHONPATH=$(pwd):$PYTHONPATH" >> $GITHUB_ENV

      - name: Install poetry
        run: |
          pip install --upgrade pip
          pip install poetry==2.0.1


      - name: Install dependencies with Poetry
        working-directory: ./niffler-tests-python
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi --no-root

      - name: Install Playwright browsers
        working-directory: ./niffler-tests-python
        run: |
          poetry run playwright install chromium
          poetry run playwright install-deps


      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build containers
        run: |
          bash docker-compose-dev.sh

      - name: Add in hosts
        run: |
          echo -e "127.0.0.1\tlocalhost\n127.0.0.1\tfrontend.niffler.dc\n127.0.0.1\tauth.niffler.dc\n127.0.0.1\tgateway.niffler.dc\n127.0.0.1\tuserdata.niffler.dc\n127.0.0.1\tkafka" | sudo tee -a /etc/hosts

      - name: Install poetry
        run: |
          pip install --upgrade pip
          pip install poetry==2.0.1


      - name: Install dependencies with Poetry
        working-directory: ./niffler-tests-python
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi --no-root

      - name: Install Playwright browsers
        working-directory: ./niffler-tests-python
        run: |
          poetry run playwright install chromium
          poetry run playwright install-deps
      - name: Run tests with pytest
        working-directory: ./niffler-tests-python
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Python..."
          poetry run pytest -v --tb=long --capture=no
        continue-on-error: false
      - name: Upload Logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pytest-logs
          path: niffler-tests-python/logs

      - name: Load test report history
        uses: actions/checkout@v3
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
#          path: niffler-e-2-e-tests-python/allure-history

      - name: Generate Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: niffler-tests-python/allure-results
          allure_history: gh-pages/history
          allure_report: niffler-tests-python/allure-report
          gh_pages: gh-pages
          keep_reports: 20

      - name: Upload Allure Report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: niffler-tests-python/allure-report

      - name: Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: gh-pages/history
          keep_files: true

#      - name: Upload Allure results
#        uses: actions/upload-artifact@v4
#        if: always()
#        with:
#          name: allure-results
#          path: niffler-tests-python/allure-results/
#          retention-days: 30
#
#  allure-report:
#    needs: test
#    if: always()
#    runs-on: ubuntu-latest
#    steps:
#      - name: Download all Allure results
#        uses: actions/download-artifact@v4
#        with:
#          path: allure-results
#          pattern: allure-results-*
#          merge-multiple: true
#
#      - name: Generate Allure Report
#        uses: simple-elf/allure-report-action@v1.12
#        with:
#          allure_results: niffler-tests-python/allure-results
#          allure_history: gh-pages/history
#          allure_report: niffler-e-2-e-tests-python/allure-report
#          gh_pages: gh-pages
#          keep_reports: 20
#
#      - name: Deploy Allure report to GitHub Pages
#        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
#        uses: peaceiris/actions-gh-pages@v4
#        with:
#          github_token: ${{ secrets.GITHUB_TOKEN }}
#          publish_branch: gh-pages
#          publish_dir: allure-history
#          destination_dir: ${{ github.run_number }}
