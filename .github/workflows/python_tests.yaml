name: Run Python Tests for Niffler

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file
        working-directory: ./niffler-tests-python
        run: |
          cat > .env << EOF
          USER_NAME="${{ secrets.USER_NAME }}"
          PASSWORD="${{ secrets.PASSWORD }}"
          FRONT_URL="http://frontend.niffler.dc"
          AUTH_URL="http://auth.niffler.dc:9000"
          GATEWAY_URL="http://gateway.niffler.dc:8090"
          SPEND_DB_URL="postgresql+psycopg2://postgres:secret@localhost:5432/niffler-spend"
          AUTH_DB_URL="postgresql+psycopg2://postgres:secret@localhost:5432/niffler-auth"
          USERDATA_DB_URL="postgresql+psycopg2://postgres:secret@localhost:5432/niffler-userdata"
          KAFKA_BOOTSTRAP_SERVERS="localhost:9093"
          EOF
          
          echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω:"
          cat .env | grep -v PASSWORD | grep -v SECRET

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Set PYTHONPATH
        run: |
          echo "PYTHONPATH=$(pwd):$PYTHONPATH" >> $GITHUB_ENV

      - name: Install poetry
        run: |
          pip install --upgrade pip
          pip install poetry==2.0.1


      - name: Install dependencies with Poetry
        working-directory: ./niffler-tests-python
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi --no-root

      - name: Install Playwright browsers
        working-directory: ./niffler-tests-python
        run: |
          poetry run playwright install chromium
          poetry run playwright install-deps


      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build containers
        run: |
            bash docker-compose-dev.sh
            sleep 30

            wait_for_healthy() {
            local container=$1
            local max_attempts=60
            local attempt=1
            
            echo -n "  $container: "
            while [ $attempt -le $max_attempts ]; do
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ docker inspect
              status=$(docker inspect --format='{{.State.Health.Status}}' $container 2>/dev/null || echo "no health")
              
              if [ "$status" = "healthy" ]; then
                echo "‚úÖ healthy (—á–µ—Ä–µ–∑ $((attempt*3)) —Å–µ–∫)"
                return 0
              fi
              
              if [ "$status" = "no health" ]; then
                # –ï—Å–ª–∏ –Ω–µ—Ç health check, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ—Å—Ç–æ running
                running=$(docker inspect --format='{{.State.Status}}' $container)
                if [ "$running" = "running" ]; then
                  echo "‚úÖ running (–±–µ–∑ health check)"
                  return 0
                fi
              fi
              
              sleep 3
              attempt=$((attempt + 1))
            done
            
            echo "‚ùå –Ω–µ healthy –ø–æ—Å–ª–µ $((max_attempts*3)) —Å–µ–∫"
            return 1
          }
          
          # –ñ–¥–µ–º –≤—Å–µ –≤–∞–∂–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          wait_for_healthy "niffler-all-db"
          wait_for_healthy "auth.niffler.dc"
          wait_for_healthy "gateway.niffler.dc"
          wait_for_healthy "userdata.niffler.dc"
          wait_for_healthy "spend.niffler.dc"
          wait_for_healthy "currency.niffler.dc"
          wait_for_healthy "frontend.niffler.dc"
          
          echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–¥–æ—Ä–æ–≤—ã!"
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ curl
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ curl:"
          for i in {1..30}; do
            if curl -s http://gateway.niffler.dc:8090/actuator/health | grep -q "UP"; then
              echo "  Gateway –æ—Ç–≤–µ—á–∞–µ—Ç —á–µ—Ä–µ–∑ $((i*3)) —Å–µ–∫"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Gateway –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
              exit 1
            fi
            sleep 3
          done
#      - name: Add hosts to /etc/hosts
#        run: |
#          echo "127.0.0.1 frontend.niffler.dc" | sudo tee -a /etc/hosts
#          echo "127.0.0.1 auth.niffler.dc" | sudo tee -a /etc/hosts
#          echo "127.0.0.1 gateway.niffler.dc" | sudo tee -a /etc/hosts
#          cat /etc/hosts | grep niffler
      - name: Add hosts with IPs
        run: |
          echo -e "127.0.0.1\tlocalhost\n127.0.0.1\tfrontend.niffler.dc\n127.0.0.1\tauth.niffler.dc\n127.0.0.1\tgateway.niffler.dc\n127.0.0.1\tuserdata.niffler.dc\n127.0.0.1\tkafka" | sudo tee -a /etc/hosts
#        run: |
#            # –ü–æ–ª—É—á–∞–µ–º IP –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
#            AUTH_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' auth.niffler.dc)
#            GATEWAY_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' gateway.niffler.dc)
#            FRONTEND_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' frontend.niffler.dc)
#
#            echo "Auth IP: $AUTH_IP"
#            echo "Gateway IP: $GATEWAY_IP"
#            echo "Frontend IP: $FRONTEND_IP"
#
#            # –î–æ–±–∞–≤–ª—è–µ–º –≤ hosts
#            echo "$AUTH_IP auth.niffler.dc" | sudo tee -a /etc/hosts
#            echo "$GATEWAY_IP gateway.niffler.dc" | sudo tee -a /etc/hosts
#            echo "$FRONTEND_IP frontend.niffler.dc" | sudo tee -a /etc/hosts


      - name: Run tests with pytest
        working-directory: ./niffler-tests-python
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Python..."
          poetry run pytest -v --tb=long --capture=no
        continue-on-error: false
      - name: Upload Logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pytest-logs
          path: niffler-tests-python/logs

      - name: Load test report history
        uses: actions/checkout@v3
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
#          path: niffler-e-2-e-tests-python/allure-history

      - name: Generate Allure Report
        if: always()
        uses: simple-elf/allure-report-action@master
        with:
          allure_results: niffler-tests-python/allure-results
          allure_history: gh-pages/history
          allure_report: niffler-tests-python/allure-report
          gh_pages: gh-pages
          keep_reports: 20

      - name: Upload Allure Report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: niffler-tests-python/allure-report

      - name: Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: gh-pages/history
          keep_files: true

#      - name: Upload Allure results
#        uses: actions/upload-artifact@v4
#        if: always()
#        with:
#          name: allure-results
#          path: niffler-tests-python/allure-results/
#          retention-days: 30
#
#  allure-report:
#    needs: test
#    if: always()
#    runs-on: ubuntu-latest
#    steps:
#      - name: Download all Allure results
#        uses: actions/download-artifact@v4
#        with:
#          path: allure-results
#          pattern: allure-results-*
#          merge-multiple: true
#
#      - name: Generate Allure Report
#        uses: simple-elf/allure-report-action@v1.12
#        with:
#          allure_results: niffler-tests-python/allure-results
#          allure_history: gh-pages/history
#          allure_report: niffler-e-2-e-tests-python/allure-report
#          gh_pages: gh-pages
#          keep_reports: 20
#
#      - name: Deploy Allure report to GitHub Pages
#        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
#        uses: peaceiris/actions-gh-pages@v4
#        with:
#          github_token: ${{ secrets.GITHUB_TOKEN }}
#          publish_branch: gh-pages
#          publish_dir: allure-history
#          destination_dir: ${{ github.run_number }}
